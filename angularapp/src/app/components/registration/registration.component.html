<div class="container">
  <h2>SMART MART - Registration</h2>

  <form #f="ngForm" (ngSubmit)="onSubmit(f)" novalidate>

    <div class="form-group">
      <label for="username">Username <span style="color: red;">*</span></label>
      <input type="text" id="username" name="username" [(ngModel)]="user.username" required #username="ngModel"
        (blur)="checkUsernameAvailability()">
      <div *ngIf="username.invalid && username.touched" class="error">Username is required.</div>
      <div *ngIf="usernameExists && user.username" class="error">Username Already Exists!</div>
    </div>

    <div class="form-group">
      <label for="email">Email <span style="color: red;">*</span></label>
      <div class="d-flex align-items-center">
      <input type="email" id="email" name="email" [(ngModel)]="user.email" required
        pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$" #email="ngModel" [disabled]="this.emailOtpVerification">
      <button type="button" class="btn btn-primary" style="margin-left:8px; white-space: nowrap;" (click)="openEmailOtpModal()" [disabled]="this.emailOtpVerification">Get OTP</button>
      </div>
      <div *ngIf="email.invalid && email.touched" class="error">
        <div *ngIf="email.errors?.required">Email is required.</div>
        <div *ngIf="email.errors?.pattern">Enter a valid email address</div>
      </div>
    </div>

    <div class="form-group">
      <label for="password">Password <span style="color: red;">*</span></label>
      <input type="password" id="password" name="password" [(ngModel)]="user.password" required
        pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}" #password="ngModel">
      <div *ngIf="password.invalid && password.touched" class="error">
        <div *ngIf="password.errors?.required">Password is required.</div>
        <div *ngIf="password.errors?.pattern">
          Password must be at least 8 characters long and contain letters, numbers, and special characters.
        </div>
      </div>
    </div>

    <div class="form-group">
      <label for="confirmPassword">Confirm Password <span style="color: red;">*</span></label>
      <input type="password" id="confirmPassword" name="confirmPassword" [(ngModel)]="user.confirmPassword" required
        #confirmPassword="ngModel">
      <div *ngIf="confirmPassword.invalid && confirmPassword.touched" class="error">Confirm Password is required.</div>
      <div *ngIf="user.password && user.confirmPassword && user.password !== user.confirmPassword" class="error">
        Passwords do not match.
      </div>
    </div>

    <div class="form-group">
      <label for="mobileNumber">Mobile Number <span style="color: red;">*</span></label>
      <div class="mobile-input">
        <span>+91</span>
        <input type="text" id="mobileNumber" name="mobileNumber" [(ngModel)]="user.mobileNumber" required
          pattern="^[6-9][0-9]{9}$" #mobileNumber="ngModel" (blur)="checkPhonenumberAvailability()" [disabled]="this.otpVerification">
        <button type="button" class="btn btn-primary ml-2" style="white-space: nowrap;" (click)="openPhoneOtpModal()" [disabled]="this.otpVerification">Get OTP</button>
      </div>
      <div *ngIf="mobileNumber.invalid && mobileNumber.touched" class="error">
        <div *ngIf="mobileNumber.errors?.required">Mobile number is required.</div>
        <div *ngIf="mobileNumber.errors?.pattern">Mobile number must start with 6,7,8 or 9 and must be of 10 digits.</div>
      </div>
      <div *ngIf="phoneNumberExists && user.mobileNumber && mobileNumber.valid" class="error">Phone Number Already Exists!</div>
    </div>

    <div class="form-group">
      <label for="role">Role <span style="color: red;">*</span></label>
      <select id="role" name="role" [(ngModel)]="user.role" required #role="ngModel">
        <option value="" disabled selected>Select Role</option>
        <option value="USER">User</option>
        <option value="PENDING_ADMIN">Request for Admin</option>
      </select>
      <div *ngIf="role.invalid && role.touched" class="error">Role is required.</div>
    </div>

    <button type="submit" [disabled]="f.invalid|| !otpVerification || !emailOtpVerification" (click)="successModal()">Register</button>

    <p>Already have an account? <a routerLink="/login">Login</a></p>
  </form>

 
  <div *ngIf="registrationSuccess" class="modal fade show d-block" tabindex="-1"
    style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" >
          <h5 class="modal-title">Registration Successful</h5>
        </div>
        <div class="modal-body">
          <p>Your account has been created successfully. You can now log in to your account.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" (click)="onConfirmSuccess()">OK</button>
        </div>
      </div>
    </div>
  </div>



  <div class="modal fade" id="emailOtpModal" tabindex="-1" aria-labelledby="emailOtpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="emailOtpModalLabel">Verify Email OTP</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="text" class="form-control" [(ngModel)]="enteredOtp" placeholder="Enter Email OTP">
          <div class="mt-3 d-flex justify-content-between">
            <button class="btn btn-success" (click)="verifyEmailOtp()">Verify OTP</button>
            <button class="btn btn-warning" (click)="resendEmailOtp()">Resend OTP</button>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div class="modal fade" id="phoneOtpModal" tabindex="-1" aria-labelledby="phoneOtpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="phoneOtpModalLabel">Verify Phone OTP</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="text" class="form-control" [(ngModel)]="enteredOtp" placeholder="Enter Phone OTP">
          <div class="mt-3 d-flex justify-content-between">
            <button class="btn btn-success" (click)="verifyPhoneOtp()">Verify OTP</button>
            <button class="btn btn-warning" (click)="resendPhoneOtp()">Resend OTP</button>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resultModalLabel">OTP Status : {{otpStatusMessage}}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-footer modal-content">
          <button type="button" class="btn btn-primary" (click)="closeAllModals()">OK</button>
        </div>
      </div>
    </div>
  </div>
</div>
